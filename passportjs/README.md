# КОЛЛЕКЦИЯ КНИГ - АВТОРИЗАЦИЯ (PassportJS)

## Описание

Сервер авторизации сайта "Коллекция книг" предоставляет следующие возможности:
1. Регистрация пользователя (`/user/signup`).
2. Авторизация пользователя (`/user/login`).
3. Просмотр профиля пользователя (`/user/me`).
4. Вызод из систнемы (`/user/logout`).

Дополнительно реализован API для работы с пользователями
1. Добавление пользователя в БД (`POST /api/user/signup`).
2. Получение информации о пользователе (`GET /api/user/:id`).


## БД MONGODB

Для хранения пользователей используется БД MongoDB, которая запускается из контейнеров.
Файл запуска - [Docker-compose.yml](Docker-compose.yml).

Используется библиотека - *mongoose*.

## Модель *USER* ([models/user.js](src/models/user.js))


Модель "USER" реализована в файле [src/models/user.js](src/models/user.js).

### Атрибуты сущности

`login` - имя пользователя в системе (`String unique required`),

`name` - имя (`String required`),

`email` - адрес электронной почты (`String required`),

`password` - хеш-строка пароля (`String required`),

`salt` - доп.строка, используемая для формирования хеш-строки пароля (`String`).


### Методы сущности

Дополнительно реализованы методы модели "USER":

`checkPasswords(password, cb)` ([код](src/models/user.js#L28)) - проверка соответствия пароля пользователя и введенного пароля `password`. В случае соответствия вызыввается callback-функция `cb(true)`, в случае несоответствия - `cb(false)`.


`pre('save', next)` ([код](src/models/user.js#L38)) - функция предварительной обработки новых пользователей перед сохранением. Формирует доп.строку ("соль") и хеш-строку пароля, которые и сохраняются в БД. 

Для формирования хеш-строки используется библиотека `bcrypt` и функции, реализованные в файле [src/hash.js](src/hash.js).



## Основной файл ([index.js](src/index.js))

Основной код сервера реализован в файле [index.js](src/index.js). Используется библиотека `Express` для запуска сервера. Все параметры передаются в теле запросов в виде JSON-объектов, результат работы методов - JSON-данные.

Используется библиотека `Mongoose` для работы с БД MongoDB.

### Инициализация Mongo
В файле [mongo-init.js](mongo-init.js) содержится сценарий, создающий БД `Bookstore` и коллекцию `Users`. ТАкже создается пользователь `user:user` для работы с БД `Bookstore`. Данный сценарий выполняется один раз при первом запуске контейнера mongo.





## Запуск


1. Создать папку для хранения данных (например, `data`).
2. В файле [docker-compose.yml](Docker-compose.yml) для контейнера __mongo__  указать монтируемый путь /`data/db` на созданную в п.1 папку: `./mongo/data:/data/db`
3. В файле [docker-compose.yml](Docker-compose.yml) для контейнера __mongo__  задать порт проброса с хоста (например, `ports: [ 27017:27017 ]`).
5. Выполнить команду
```
docker compose up
```
6. После запуска всех контейнеров выполнить команду:
   - для отладки:
     ```
     npm run watch
     ```
   - для запуска рабочей версии
     ```
     npm run start
     ``` 
