# КОЛЛЕКЦИЯ КНИГ - RESTful backend server (CRUD API)

## Описание

Сервер __"Коллекция книг"__ предоставляет следующие возможности (API):
1. Авторизация пользователя (`POST /api/user/login`).
2. Получение списка хранимых книг (`GET /api/books`).
3. Получение информации об отдельной книге (`GET /api/books/:id`).
4. Добавление книги в коллекцию (`POST /api/books`).
5. Изменение информации о книге из коллекции (`PUT /api/books/:id`).
6. Загрузка файла с содержимым книги (`POST /api/books/:id/upload`).
7. Скачивание файла с содержимым книги (`GET /api/books/:id/download`).
8. Удаление книги из коллекции (`DELETE /api/books/:id`).

Приложение поддерживает сохранение состояния при выключении (запись в файл).

## Сущности и классы

Для реализации функционала сервера разработаны две сущности и методы для них: сущность *КНИГА* и сущность *КОЛЛЕКЦИЯ КНИГ*.

### Сущность "Книга" ([book.js](src/book.js))

Сущность "Книга" реализована в файле [book.js](src/book.js).

Атрибуты сущности:

`title` - название книги (`String`),

`description` - описание книги (`String`),

`authors` - авторы книги (`String`),

`favorite` - жанр книги (`String`),

`fileCover` - имя файла с картинкой обложки (`String`),

`fileName` - имя файла с текстом (`String`),

`id` - внутренний идентификатор книги (используется внутри системы, назначается автоматически)
 

 ### Сущность "Коллекция книг" ([bookStorage.js](src/bookStorage.js))

Сущность "Коллекция книг" реализована в файле [bookStorage.js](src/bookStorage.js).

Методы сущности:

`getAll()` - возвращает массив книг (`[]`)

`get(id)`  - возвращает информацию о конкретной книге с идентификатором `id` или `undefined`, если книга не найдена

`add(item)` - добавление книги `item` (объект класса Book) в хранимый массив и возвращает общее число книг или `-1`, если ошибка добавления

`modify(id, item)` - изменяет информацию о книге с идентификатором `id`. Новая информация представлена в объекте класса Book - `item`. Старый идентификатор книги сохраняется. Метод возвращает обновленную информацию книги или `undefined`, если книга с идентификатором `id` не найдена.

`delete(id)` - удаление книги с идентификатором `id`. Метод возвращает `1` в случае успешного удаления или `0` - в случае ошибки.

`dumpToFile()` - сохранение массива книг в файле-дампе (`bookstorage.json`). Путь до файла задается в [конфигурационном файле](config.json) или в переменных окружения.

## Маршруты ([routes](src/routes))

### Пути `/api/user` ([routes/user.js](src/routes/user.js))

`POST /api/user/login` - аутентификация ([код](src/routes/user.js#L13)). Возвращает объект `{id, mail}`. Код успеха - 201.


### Пути `/api/books` ([routes/books.js](src/routes/books.js))

Путь может быть изменен в [конфигурационном файле](config.json) (`"routes": { "books": "...", "users": "..." }`).
 

`GET /api/books` - получение списка книг ([код](src/routes/books.js#L20)). Возвращает массив объектов типа Book `[{...}, {...}, ...]`. Код успеха - 200.

`GET /api/books/:id` - получение информации о книге с идентификатором `id` ([код](src/routes/books.js#L39)). Возвращает объект типа Book. Код успеха - 200. Код ошибки - 404.

`POST /api/books` - добавление новой книги ([код](src/routes/books.js#L66)). В теле запроса должен быть JSON-объект со значениями параметров книги (`{title,description,authors,favorite,fileCover,fileName}`), а также сам файл, который загружается на сервер (`fileBook`) и его оригинальное имя (`fileName`). Возвращает саму добавленную книгу - объект класса Book. Код успеха - 201. Код ошибки - 403.

`PUT /api/books/:id` - редактирование информации о книги с идентификатором `id` ([код](src/routes/books.js#L122)). В теле запроса должен быть JSON-объект с новыми значениями параметров книги (`{title,description,authors,favorite,fileCover,fileName}`). Возвращает измененную информацию о книге - объект класса Book. Код успеха - 200. Код ошибки - 404.

`POST /api/books/:id/upload` - загрузка на сервер файла для выбранной книги с идентификатором `id` ([код](src/routes/books.js#L172)). Файл должен быть в форме `multipart-formdata` в поле с именем `fileBook`. Возвращает измененный объект с именем добавленного файла ({...}) или информация об ошибке {"errcode", "errmsg"}. Код успеха - 200. Код ошибки - 404.

`GET /api/books/:id/download` - скачивание файла для выбранной книги с идентификатором `id` ([код](src/routes/books.js#L220)). Возвращает содержимое файла с оригинальным именем или информация об ошибке {"errcode", "errmsg"}. Код успеха - 200. Код ошибки - 404.

`DELETE /api/books/:id` - удаление книги с идентификатором `id` ([код](src/routes/books.js#L260)). Возвращает 'ok' или пусто. Код успеха - 200. Код ошибки - 404.


## Промежуточные обработчики ([middleware](src/middleware))

### Журналирование обращение ([middleware/logger.js](src/middleware/logger.js))
В данном обработчике реализовано ведение журнала обращений на сервер в файле `server.log`.

Формат записи:
```
ДД.ММ.ГГГГ ЧЧ:ММ:СС - МЕТОД     URL
```

### Обработка страницы 404 ([middleware/err404.js](src/middleware/err404.js))
Все пути, не указанные для обработки переводятся на страницу 404.

Возвращаемый код - 404.

Возвращаемый текст: `Страница ${url} не найдена`.

### Обработка загрузки файлов ([middleware/fileMulter.js](src/middleware/fileMulter.js))
Для загрузки фалов используется библиотека `Multer`. Обработчик сохрняет загружаемые файлы в папке, которая задается в конфигурационном файле ([config.json](config.json)) или в переменных окружения.

Имя файлов - `ID_DATE.ext`.


## Основной файл ([index.js](src/index.js))

Основной код сервера реализован в файле [index.js](src/index.js). Используется библиотека `Express` для запуска сервера. Все параметры передаются в теле запросов в виде JSON-объектов, результат работы методов - JSON-данные.


## Запуск

### Запуск локально

Запуск в режиме отладки:
```
npm run watch
```

Запуск для работы:
```
npm start
```

### Запуск в docker-е

Готовый образ - [makevg/bookstor_api](https://hub.docker.com/repository/docker/makevg/bookstor_api/general)

ля сборки используются:
  - [Dockerfile](Dockerfile) для релиза 
  - [Dockerfile_debug](Dockerfile_debug) для отладки

Сборка docker-а:
```
docker build .
```

ИЛИ

```
docker build -f Dockerfile_debug .
```

### Переменные среды

Параметры запуска задаются либо в файле [config.json](config.json) или в переменных окружения, заданных в файле [docker-compose.yml](../docker-compose.yml)

Пример содержимого конфигурационного файла:
```
{
    "hostname": "bookserver_api",
    "port": 5000,
    "data_path": "../data/",
    "routes": {
        "books": "/api/books"
    }
}
```

Пример задания через переменные окружения:
```
    environment:
      NODE_ENV: production
      HOSTNAME: bookserver_api
      PORT: 5000
      DATA_PATH: ../data/
```

Порт по умолчанию: __5000__.

### Приоритетность параметров

Приоритетность параметров запуска:

1. Переменные окружения (`process.env`).
2. Конфигурационный файл ([config.json](config.json)).
3. Значения по умолчанию (заданы в коде).
