# СЧЕТЧИК СКАЧИВАНИЙ КНИГ - дополнение к серверу хранения книг BOOKSTOR

## Описание

Сервер __"Счетчик скачиваний"__ предоставляет следующие возможности (API):
1. Получение счетчика скачивания отдельной книги (`GET /api/counter/:bookId`).
2. Увеличение счетчика скачивания отдельной книги (`POST /api/counter/:bookId/inc`).
3. Удаление счетчика скачивания отдельной книги (`DELETE /api/counter/:bookId`).

Приложение поддерживает сохранение состояния при выключении (запись в файл).

## Сущности и классы

Для реализации функционала сервера разработаны две сущности и методы для них: сущность *СЧЕТЧИК* и сущность *КОЛЛЕКЦИЯ СЧЕТЧИКОВ*.

### Сущность "Счетчик" ([counter.js](src/counter.js))

Сущность "Счетчик" реализована в файле [counter.js](src/counter.js).

Атрибуты сущности:

`bookId` - идентификатор книги  (`String` или `integer`),

`counter` - число скачиваний книги (`integer`),

`datetime` - время последнего скачинвания книги (`String`), 

 ### Сущность "Коллекция счетчиков" ([counterStorage.js](src/counterStorage.js))

Сущность "Коллекция счетчиков" реализована в файле [counterStorage.js](src/counterStorage.js).

Методы сущности:

`getAll()` - возвращает массив счетчиков (`[]`)

`get(bookId)`  - возвращает счетчик выбранной книги с идентификатором `bookId` или `undefined`, если счетчик не найдена

`inc(bookId)` - увеличение счетчика скачиваний книги с идентификатором `bookId` на 1, если счетчика не было, то создается новая запись со значением 1. Возвращается измененный счетчик.

`delete(bookId)` - удаление счетчика скачивания книги с идентификатором `bookId`. Метод возвращает `1` в случае успешного удаления или `0` - в случае ошибки.

`dumpToFile()` - сохранение массива счетчиков в файле-дампе (`bookcounter.json`). Путь до файла задается в [конфигурационном файле](config.json) или в переменных окружения.

## Маршруты ([routes](src/routes))

### Пути `/api/counter` ([routes/counter.js](src/routes/counter.js))

Путь может быть изменен в [конфигурационном файле](config.json) (`"routes": { "counter": "..."}`).
    
`GET /api/counter/:bookId` - получение счетчика скачивания книги с идентификатором `bookId` ([код](src/routes/counter.js#L14)). Возвращает объект типа Counter. Код успеха - 200. Код ошибки - 404.

`POST /api/counter/:bookId/inc` - увеличение счетчика скачивания книги с идентификатором `bookId` на 1 ([код](src/routes/counter.js#L43)). Возвращает новый счетчик типа Counter. Код успеха - 201. Код ошибки - 403.

`DELETE /api/counter/:bookId` - удаление счетчика книги с идентификатором `bookId` ([код](src/routes/counter.js#L73)). Возвращает '1' или пусто. Код успеха - 200. Код ошибки - 404.

## Основной файл ([index.js](src/index.js))

Основной код сервера реализован в файле [index.js](src/index.js). Используется библиотека `Express` для запуска сервера. Все параметры передаются в теле запросов в виде JSON-объектов, результат работы методов - JSON-данные.


## Запуск

### Запуск локально

Запуск в режиме отладки:
```
npm run watch
```

Запуск для работы:
```
npm start
```

### Запуск в docker-е

Готовый образ - [makevg/bookstor_counter](https://hub.docker.com/repository/docker/makevg/bookstor_counter/general)

Для сборки используются:
  - [Dockerfile](Dockerfile) для релиза 
  - [Dockerfile_debug](Dockerfile_debug) для отладки

Сборка docker-а:
```
docker build .
```

ИЛИ

```
docker build -f Dockerfile_debug .
```

### Переменные среды

Параметры запуска задаются либо в файле [config.json](config.json) или в переменных окружения, заданных в файле [docker-compose.yml](../docker-compose.yml)

Пример содержимого конфигурационного файла:
```
{
    "hostname": "bookserver_ejs",
    "port": 3000,
    "data_path": "../data/fileBook",
    "api_server": "localhost",
    "api_port": 5000,
    "counter_server": "localhost",
    "counter_port": 5010
}
```

Пример задания через переменные окружения:
```
    environment:
      NODE_ENV: production
      HOSTNAME: bookserver_counter
      PORT: 5010
      DATA_PATH: ../data/
```

Порт по умолчанию: __5010__.

### Приоритетность параметров

Приоритетность параметров запуска:

1. Переменные окружения (`process.env`).
2. Конфигурационный файл ([config.json](config.json)).
3. Значения по умолчанию (заданы в коде).