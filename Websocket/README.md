# КОЛЛЕКЦИЯ КНИГ - WEBSOCKETS (SocketIO)

## Описание

Сервер общения в режиме реального времени на основе технологии WebSocket сайта "Коллекция книг" предоставляет следующие возможности:
1. Регистрация пользователя (`/user/signup`).
2. Авторизация пользователя (`/user/login`).
3. Просмотр профиля пользователя (`/user/me`).
4. Вызод из систнемы (`/user/logout`).
5. Общий чат (`/chat`).

Хранение информации о пользователях реализовано с использованием
- БД Mongo
- файлов `*.json`.

Конкретный вариант задается в конфигурационном файле [config.json](config.json) или в переменных окружения (`process.env`).


## Хранилище

Основной класс по использованию хрнилища `BookStorage` реализован в файле [src/storage/bookStorage.js](src/storage/bookStorage.js). Поддерживаемые методы:

- `getAll()` - возвращение всех записей в контейнере

- `get(id)` - возвращение объекта с идентификатором ID или undefined, если запись не найдена

- `add(item)` - добавление объекта item в контейнер (ID присваивается автоматически). Возвращает добавленный объект.

- `modify(id, item)` - изменение объекта с идентификатором ID. Возвращает измененный объект или undefined, если объект не найден.

- `delete(id)` - удаление объекта с идентификатором ID. Возвращает 1 в случае успеха и 0 - при ошибке. 

### БД MONGODB

Для хранения пользователей используется БД MongoDB, которая запускается из контейнеров.
Файл запуска - [Docker-compose.yml](Docker-compose.yml).

Используется библиотека - *mongoose*.

#### Модель *USER* ([models/user.js](src/models/user.js))


Модель "USER" реализована в файле [src/models/user.js](src/models/user.js).

#### Атрибуты сущности

`login` - имя пользователя в системе (`String unique required`),

`name` - имя (`String required`),

`email` - адрес электронной почты (`String required`),

`password` - хеш-строка пароля (`String required`),

`salt` - доп.строка, используемая для формирования хеш-строки пароля (`String`).


#### Методы сущности

Дополнительно реализованы методы модели "USER":

`checkPasswords(password, cb)` ([код](src/models/user.js#L29)) - проверка соответствия пароля пользователя и введенного пароля `password`. В случае соответствия вызыввается callback-функция `cb(true)`, в случае несоответствия - `cb(false)`.


`pre('save', next)` ([код](src/models/user.js#L39)) - функция предварительной обработки новых пользователей перед сохранением. Формирует доп.строку ("соль") и хеш-строку пароля, которые и сохраняются в БД. 

Для формирования хеш-строки используется библиотека `bcrypt` и функции, реализованные в файле [src/hash.js](src/hash.js).


### Хранилище на основе файлов

Используется контейнер [src/storage/bookFile.js](src/storage/bookFile.js).

Реализованы такие же методы, что и при работе с БД Mongo.


## Основной файл ([index.js](src/index.js))

Основной код сервера реализован в файле [src/index.js](src/index.js). Используется библиотека `Express` для запуска сервера. Все параметры передаются в теле запросов в виде JSON-объектов, результат работы методов - JSON-данные.

Используется библиотека `Mongoose` для работы с БД MongoDB.

### Инициализация Mongo
В файле [mongo-init.js](mongo-init.js) содержится сценарий, создающий БД `Bookstore` и коллекцию `Users`. ТАкже создается пользователь `user:user` для работы с БД `Bookstore`. Данный сценарий выполняется один раз при первом запуске контейнера mongo.


## Чат

Для реализации чата используется библиотека `Socket.IO`. Функционал реализован в файле [src/routes/chat.js](src/routes/chat.js).

Используется шаблон [src/views/pages/chat/index.ejs](src/views/pages/chat/index.ejs).

Соединение устанавливается в файле [src/index.js](src/index.js#L95).

Типы сообщений:
- `message-to-me` - сообщение только себе,
- `message-to-all` - сообзение всем,
- `message-to-room` - сообщение выбранной комнате _(на текущий момент нет фукнционалда выбора комнаты - на всех она одна)_.

Формат сообщения:
```
{
  type: // имя комнаты,
  name: // имя пользователя,
  text: // текст сообщения,
  date: // время отправки сообщения
}
```

## Запуск


### Запуск с использованием БД Mongo

1. Создать папку для хранения данных (например, `data`).
2. В файле [docker-compose.yml](Docker-compose.yml) для контейнера __mongo__  указать монтируемый путь `data/db` на созданную в п.1 папку: `./mongo/data:/data/db`.
3. В файле [docker-compose.yml](Docker-compose.yml) для контейнера __mongo__  задать порт проброса с хоста (например, `ports: [ 27017:27017 ]`).
4. В файле [cofig.json](config.json) в значении поля `"STORAGE_TYPE"` указать `"mongo"`.
5. Выполнить команду
```
docker compose up
```
6. После запуска всех контейнеров выполнить команду:
   - для отладки:
     ```
     npm run watch
     ```
   - для запуска рабочей версии
     ```
     npm run start
     ``` 

### Запуск с использованием файлового хранилища

1. Создать папку для хранения данных (например, `data`).
2. В файле [cofig.json](config.json) в значении поля `"DATA_PATH"` указать путь, где будет располагаться файл, например, `"data/"`.
3. В файле [cofig.json](config.json) в значении поля `"STORAGE_TYPE"` указать `"file"`.
4. Выполнить команду запуска:
   - для отладки:
     ```
     npm run watch
     ```
   - для запуска рабочей версии
     ```
     npm run start
     ``` 